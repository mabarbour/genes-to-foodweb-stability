---
title: "Plant growth in the absence of insects"
author: "Matthew A. Barbour"
date: "`r Sys.Date()`"
output: workflowr::wflow_html
editor_options:
  chunk_output_type: console
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, message = FALSE)

# load required libraries
library(tidyverse)
library(kableExtra)
library(clubSandwich)
library(cowplot)

# set ggplot theme
theme_set(theme_cowplot())
```

# Setup

```{r}
# load data
ChamberNoInsectsDF <- read_csv("data/PreExperimentNoInsectsPlantBiomass.csv") %>%
  mutate(Cage = as.character(Cage),
         Pot = as.character(Pot))

# conduct analyses at cage level
CageLevelBiomass <- ChamberNoInsectsDF %>%
  # sum biomass across both pots
  group_by(Cage, Temperature, Richness, Composition, Col, gsm1, AOP2, AOP2.gsoh) %>%
  summarise_at(vars(Biomass_g), list(sum)) %>%
  # tidy data
  ungroup() %>%
  select(cage = Cage, temp = Temperature, rich = Richness, com = Composition, Col, gsm1, AOP2, AOP2.gsoh, Biomass_g) %>%
  # adjust temp and rich so effect of +1 C is comparable to +1 genotype
  mutate(temp = ifelse(temp == "20 C", 0, 3),
         rich = rich - 1)

# source in ANOVA GLM for adjusted F-tests
source('code/glm-ftest.R')
```

# Show equivalence of Analysis of deviance and ANOVA

An Analysis of deviance on a GLM with a gaussian error distribution is equivalent to ANOVA. However, unadjusted *F*-tests are inappropriate because all terms are tested against residual variation rather than the intended error level (e.g. `com` for `rich`). The analysis below is just to prove this equivalence. I'm doing this so I can use the same function `glm.ftest.v2` for the ANOVA in the following section.

```{r}
glm.ftest.v2(
  model = glm(data = CageLevelBiomass,
              family = gaussian(link = "identity"),
              # logging improves residual distribution
              formula = log(Biomass_g) ~ temp + rich + com + temp:rich + temp:com),
 test.formula = list(c("temp","temp:com"),
                     c("rich","com"),
                     c("temp:rich","temp:com")))[[1]]

anova(aov(log(Biomass_g) ~ temp + rich + com + temp:rich + temp:com, CageLevelBiomass))
```

# Reproduce Table S4

```{r}
# fit ANOVA
biomass_noinsects_glmf <- glm.ftest.v2(
  model = glm(data = CageLevelBiomass,
              family = gaussian(link = "identity"),
              # logging improves residual distribution
              formula = log(Biomass_g) ~ temp + rich + com + temp:rich + temp:com),
 test.formula = list(c("temp","temp:com"),
                     c("rich","com"),
                     c("temp:rich","temp:com")))[[3]] %>%
  # tidy table
  select(Source = treatment, 
         `df (Source)` = num_df, 
         `df (Error)` = den_df,
         Deviance = deviance,
         `Mean Deviance` = mean_deviance,
         F = F, P = P, Error = error) 

# reproduce table S4 in Supplementary Materials
biomass_noinsects_glmf %>%
  kable(., caption = "Analysis of variance for plant biomass (log transformed) in the absence of insects.", booktabs = T) %>%
  kable_styling(latex_options = c("striped", "hold_position"))
```

```{r include=FALSE}
# calculate effect of temperature
temp_biomass_CI <- conf_int(
  glm(data = CageLevelBiomass,
              family = gaussian(link = "identity"),
              formula = log(Biomass_g) ~ temp),
  vcov = "CR2", 
  test = "naive-t", 
  coefs = "temp", 
  cluster = with(CageLevelBiomass, paste(temp, com))) %>%
  data.frame() %>%
  rownames_to_column(var = "term")

# calculate effect of genetic diversity
rich_biomass_CI <- conf_int(
  glm(data = CageLevelBiomass,
              family = gaussian(link = "identity"),
              formula = log(Biomass_g) ~ temp + rich),
  vcov = "CR2", 
  test = "naive-t", 
  coefs = "rich", 
  cluster = CageLevelBiomass$com) %>%
  data.frame() %>%
  rownames_to_column(var = "term")

# visualize effect sizes
bind_rows(temp_biomass_CI, rich_biomass_CI) %>%
  mutate(term = factor(term, 
                       levels = c("temp","rich"))) %>%
  ggplot(aes(x = term, y = beta, color = term)) +
  geom_point(size = 3) +
  geom_hline(yintercept = 0, linetype = "dotted") +
  geom_linerange(aes(ymax = CI_U, ymin = CI_L)) +
  geom_linerange(aes(ymin = beta - SE, ymax = beta + SE), size = 1.25) +
  scale_y_continuous(name = "Change in plant biomass (log-scale)") +
  scale_x_discrete(labels = c("Warming\n (+1Â°C)","Genetic diversity\n(+1 genotype)")) +
  scale_color_manual(values = c("black","black"), guide = F) +
  xlab("") +
  theme_cowplot(font_size = 18, line_size = 1)
```

# Reproduce Fig. S8

```{r}
# calculate 95% confidence intervals with `com` as the cluster level
geno_biomass_CI_raw <- conf_int(
  glm(data = CageLevelBiomass,
              family = gaussian(link = "identity"),
              formula = log(Biomass_g) ~ -1 + temp + Col + gsm1 + AOP2 + AOP2.gsoh),
  vcov = "CR2", 
  test = "naive-t", 
  coefs = c("Col","gsm1","AOP2","AOP2.gsoh"), 
  cluster = CageLevelBiomass$com) %>%
  data.frame() %>%
  rownames_to_column(var = "term")
# note that I back transform to original scale for plotting

# plot on original scale
geno_biomass_CI_raw %>%
  mutate(term = factor(term, 
                       levels = c("Col","gsm1","AOP2","AOP2.gsoh"))) %>%
  ggplot(aes(x = term, y = exp(beta), color = term)) +
  geom_point(size = 3) +
  geom_linerange(aes(ymax = exp(CI_U), ymin = exp(CI_L))) +
  geom_linerange(aes(ymin = exp(beta - SE), ymax = exp(beta + SE)), size = 1.25) +
  scale_y_continuous(name = "Plant biomass (g)") + 
  scale_x_discrete(labels = c("Col-0","gsm1","AOP2","AOP2/gsoh")) +
  scale_color_manual(values = c("darkgreen","steelblue","darkorange","firebrick1"), guide = F) +
  xlab("") +
  theme_cowplot(font_size = 18, line_size = 1)
```

# Save analysis

Write out an `.RData` file to use for creating the Supplementary Material Results.

```{r}
save.image(file = "output/plant-growth-no-insects.RData")
```

