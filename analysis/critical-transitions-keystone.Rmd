---
title: "Critical transitions"
author: "Matthew A. Barbour"
date: "`r Sys.Date()`"
output: workflowr::wflow_html
editor_options:
  chunk_output_type: console
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, message = FALSE)

# load required libraries
library(tidyverse) # for data management
library(cowplot)
library(msm)
library(clubSandwich)
library(kableExtra)

# set ggplot theme
theme_set(theme_cowplot())
```

# Setup

```{r}
# Load and manage data
df <- read_csv("data/arabidopsis_clean_df.csv") %>%
  # renaming for brevity
  rename(cage = Cage, 
         com = Composition,
         week = Week,
         temp = Temperature,
         rich = Richness) %>%
  mutate(cage = as.character(cage),
         fweek = factor(ifelse(week < 10, paste("0", week, sep=""), week)),
         temp = ifelse(temp=="20 C", 0, 1)) %>%
  arrange(cage, week)

# create data for multi-state survival analysis
state_df <- df %>%
  # counter information is not relevant (because it is the same), so we summarise across it
  group_by(cage, fweek, week, temp, rich, Col, gsm1, AOP2, AOP2.gsoh, com) %>% 
  summarise_at(vars(BRBR_Survival, LYER_Survival, Mummy_Ptoids_Survival), list(mean)) %>% 
  ungroup() %>%
  # create possible food-web states
  mutate(BRBR = ifelse(BRBR_Survival == 1, "BRBR", ifelse(BRBR_Survival == 0, "0", NA)),
         LYER = ifelse(LYER_Survival == 1, "LYER", ifelse(LYER_Survival == 0, "0", NA)),
         Ptoid = ifelse(Mummy_Ptoids_Survival == 1, "Ptoid", ifelse(Mummy_Ptoids_Survival == 0, "0", NA))) %>%
  mutate(state = paste(BRBR, LYER, Ptoid, sep = "-"),
         cage = as.character(cage)) %>%
  # these variables are no longer needed
  select(-BRBR, -LYER, -Ptoid) %>%
  # remove all instances where all species have been labelled extinct for more than 1 week "NA-NA-NA".
  # also, only keep observations after 2 weeks when we added the parasitoid (full community)
  filter(state != "NA-NA-NA", week > 2) %>%
  mutate(week_since = week - 2) 

# replace NA with zeros for state variable
state_df$state <- gsub("NA","0", state_df$state)

# everything appears in order
arrange(state_df, cage, week_since) %>% select(cage, week_since, BRBR_Survival, LYER_Survival, Mummy_Ptoids_Survival, state) 
```

```{r}
# source in useful functions for analyses
source('code/glm-ftest.R') # ANOVA GLM
delta_prob = function(x) round(exp(x) - 1,2) # change in probability of transtion from discrete-time survival analysis

```


# Inspect critical transitions

Let's look at the possible state transitions for all cages and time points

```{r}
# state transitions for all cages and time points
msm::statetable.msm(state = state, subject = cage, data = state_df)
```

The most common transition from the full community `BRBR-LYER-Ptoid` is to lose BRBR `0-LYER-Ptoid` and less common to collapse by losing both aphids `0-0-Ptoid`. The `0-0-Ptoid` state never lasts long, since the parasitoid no longer has any resources, and collapses to `0-0-0`.

From the `0-LYER-Ptoid` community, losing the parasitoid `0-LYER-0` is the most common transition, but losing LYER `0-0-Ptoid` is also common. Note that transitions to complete collapse `0-0-0` were more than likely to occur by losing LYER then the parasitoid, rather than losing the parasitoid and then LYER. This is because collapsing from the `0-LYER-0` state is rare (1 / (131 + 1) = `r (1/132)*100`% chance per week).

These transition patterns suggest the following:

* Since the `0-0-Ptoid` state always collapses to `0-0-0`, I'm going to convert the `0-0-Ptoid` state into `0-0-0`. This will reduce the number of state transitions I need to model, but it won't sacrifice modeling the biological process. 
* Since the `0-LYER-0` to `0-0-0` transition is so rare, it does not make sense to model this transition with any covariates.

# Critical transition models

Below, we reproduce the analysis of deviance for discrete-time survival models presented in Tables S2--S3 in the Supplementary Material.

You'll notice that we code the effect of the null *AOP2*$-$ allele as `I(Col + gsm1)`, as it represents the average effect of genotypes with this allele. Similarly, we code the effect of the functional *AOP2*$+$ allele as `I(AOP2 + AOP2.gsoh)`.

## BRBR-LYER-Ptoid transition (Table S2)

```{r}
# filter data
full_transit_df <- state_df %>% 
  # removes all transitions after the first one, this focuses
  # on transition from the full community
  na.omit() 
```

```{r}
# check for weekly variation in critical transitions. 
full_transit_df %>%
  mutate(CT_from_full = ifelse(state %in% c("0-LYER-Ptoid","0-0-Ptoid"), 1, 0)) %>%
  group_by(fweek) %>%
  summarise_at("CT_from_full", mean)
```

We only observe variation between weeks 4 and 8, so we restrict the data to those weeks for the analysis. It does not make sense to include weeks where there is no variation. If we did, then the factor `fweek` would cause predict all of the variation in the week with no variation.

```{r}
# filter data again
full_transit_df <- filter(full_transit_df, week %in% c(4:8))
```

```{r}
# adjust rich and temp so coefficients = +1 genotype and +1 C, respectively
full_transit_df <- full_transit_df %>%
  mutate(rich  = rich - 1,
         temp = temp * 3)
```

Now we've put the coefficients on a similar and more intuitive scale with respect to each other.

### BRBR-LYER-Ptoid $\rightarrow$ any critical transition

```{r}
# AOP2- allele test
glm.ftest.v2(
  model = glm(data = full_transit_df,
              family = quasibinomial(link = "cloglog"), 
              formula = terms(state %in% c("0-LYER-Ptoid","0-0-Ptoid") ~
                        fweek + temp + I(AOP2 + AOP2.gsoh) + I(Col + gsm1) + com + temp:com, 
                        keep.order = T)),
  test.formula = list(
    c("fweek","Residuals"),
    c("temp","temp:com"),
    c("I(Col + gsm1)","com"))
)[[3]] %>%
  select(Source = treatment, 
         `df (Source)` = num_df, 
         `df (Error)` = den_df,
         Deviance = deviance,
         `Mean Deviance` = mean_deviance,
         F = F, P = P, Error = error) %>%
  kable(., caption = "Analysis of Deviance for any critical transition from the initial food web. Appropriate test for AOP2- allele", booktabs = T) %>%
  kable_styling(latex_options = c("striped", "hold_position"))

# AOP2+ allele test
glm.ftest.v2(
  model = glm(data = full_transit_df,
              family = quasibinomial(link = "cloglog"), 
              formula = terms(state %in% c("0-LYER-Ptoid","0-0-Ptoid") ~
                        fweek + temp + I(Col + gsm1) + I(AOP2 + AOP2.gsoh) + com + temp:com, 
                        keep.order = T)),
  test.formula = list(
    c("fweek","Residuals"),
    c("temp","temp:com"),
    c("I(AOP2 + AOP2.gsoh)","com"))
)[[3]] %>%
  select(Source = treatment, 
         `df (Source)` = num_df, 
         `df (Error)` = den_df,
         Deviance = deviance,
         `Mean Deviance` = mean_deviance,
         F = F, P = P, Error = error) %>%
  kable(., caption = "Analysis of Deviance for any critical transition from the initial food web. Appropriate test for AOP2+ allele", booktabs = T) %>%
  kable_styling(latex_options = c("striped", "hold_position"))
```

The model didn't converge...Let's try the standard `link = "logit"`.

```{r}
# AOP2- allele test
glm.ftest.v2(
  model = glm(data = full_transit_df,
              family = quasibinomial(link = "logit"), 
              formula = terms(state %in% c("0-LYER-Ptoid","0-0-Ptoid") ~
                        fweek + temp + I(AOP2 + AOP2.gsoh) + I(Col + gsm1) + com + temp:com, 
                        keep.order = T)),
  test.formula = list(
    c("fweek","Residuals"),
    c("temp","temp:com"),
    c("I(Col + gsm1)","com"))
)[[3]] %>%
  select(Source = treatment, 
         `df (Source)` = num_df, 
         `df (Error)` = den_df,
         Deviance = deviance,
         `Mean Deviance` = mean_deviance,
         F = F, P = P, Error = error) 

# AOP2+ allele test
glm.ftest.v2(
  model = glm(data = full_transit_df,
              family = quasibinomial(link = "logit"), 
              formula = terms(state %in% c("0-LYER-Ptoid","0-0-Ptoid") ~
                        fweek + temp + I(Col + gsm1) + I(AOP2 + AOP2.gsoh) + com + temp:com, 
                        keep.order = T)),
  test.formula = list(
    c("fweek","Residuals"),
    c("temp","temp:com"),
    c("I(AOP2 + AOP2.gsoh)","com"))
)[[3]] %>%
  select(Source = treatment, 
         `df (Source)` = num_df, 
         `df (Error)` = den_df,
         Deviance = deviance,
         `Mean Deviance` = mean_deviance,
         F = F, P = P, Error = error)
```

Everything converges now and the results are qualitatively the same as when `link = "cloglog"`. To maintain consistency with the other models, I report the results from `link = "cloglog"`.

### BRBR-LYER-Ptoid $\rightarrow$ 0-LYER-Ptoid

```{r}
# check for weekly variation in critical transitions.
full_transit_df %>%
  mutate(CT_to_0LYERPtoid = ifelse(state %in% "0-LYER-Ptoid", 1, 0)) %>%
  group_by(week) %>%
  summarise_at("CT_to_0LYERPtoid", mean)
```

We keep the `full_transit_df` since we observe variation in all weeks.

```{r}
# AOP2- allele
glm.ftest.v2(
  model = glm(data = full_transit_df,
              family = quasibinomial(link = "cloglog"), 
              formula = terms(state %in% c("0-LYER-Ptoid") ~
                        fweek + temp + I(AOP2 + AOP2.gsoh) + I(Col + gsm1) +  com + temp:com, 
                        keep.order = T)),
  test.formula = list(
    c("fweek","Residuals"),
    c("temp","temp:com"),
    #c("I(AOP2 + AOP2.gsoh)","com"),
    c("I(Col + gsm1)","com"))
)[[3]] %>%
  select(Source = treatment, 
         `df (Source)` = num_df, 
         `df (Error)` = den_df,
         Deviance = deviance,
         `Mean Deviance` = mean_deviance,
         F = F, P = P, Error = error) %>%
  kable(., caption = "Analysis of Deviance for critical transition from initial food web to food chain with dominant aphid and parasitoid. Appropriate test for AOP2- allele.", booktabs = T) %>%
  kable_styling(latex_options = c("striped", "hold_position"))

# AOP2+ allele
glm.ftest.v2(
  model = glm(data = full_transit_df,
              family = quasibinomial(link = "cloglog"), 
              formula = terms(state %in% c("0-LYER-Ptoid") ~
                        fweek + temp + I(Col + gsm1) + I(AOP2 + AOP2.gsoh) + com + temp:com, 
                        keep.order = T)),
  test.formula = list(
    c("fweek","Residuals"),
    c("temp","temp:com"),
    c("I(AOP2 + AOP2.gsoh)","com"))
)[[3]] %>%
  select(Source = treatment, 
         `df (Source)` = num_df, 
         `df (Error)` = den_df,
         Deviance = deviance,
         `Mean Deviance` = mean_deviance,
         F = F, P = P, Error = error) %>%
  kable(., caption = "Analysis of Deviance for critical transition from initial food web to food chain with dominant aphid and parasitoid. Appropriate test for AOP2+ allele.", booktabs = T) %>%
  kable_styling(latex_options = c("striped", "hold_position"))
```

```{r}
# calculate effects sizes for AOP2- and AOP2+ alleles, Fig. 3 of main text
conf_int(
  glm(data = full_transit_df,
              family = quasibinomial(link = "cloglog"),
              formula = state %in% c("0-LYER-Ptoid") ~
                fweek + temp + I(AOP2 + AOP2.gsoh) + I(Col + gsm1)),
  vcov = "CR2",
  test = "naive-t",
  cluster = full_transit_df$com,
  coefs = c("I(AOP2 + AOP2.gsoh)","I(Col + gsm1)")
) %>%
  data.frame() %>%
  rownames_to_column(var = "term") %>%
  group_by(term) %>%
  summarise_at(vars(beta), list(delta_prob = delta_prob))
```


### BRBR-LYER-Ptoid $\rightarrow$ 0-0-Ptoid

```{r}
# check for weekly variation in critical transitions.
full_transit_df %>%
  mutate(CT_to_00Ptoid = ifelse(state %in% "0-0-Ptoid", 1, 0)) %>%
  group_by(week) %>%
  summarise_at("CT_to_00Ptoid", mean)
```

We only see variation in weeks 7 and 8, so we restrict the data to those weeks.

```{r}
# check frequency of critical transitions
with(filter(full_transit_df, week %in% 7:8), table(state %in% c("0-0-Ptoid")))
```

And since there were only 9 total transitions to this state, we don't attempt to fit the interaction term `temp:rich`.

```{r}
# AOP2- allele
glm.ftest.v2(
  model = glm(data = filter(full_transit_df, week %in% 7:8),
              family = quasibinomial(link = "cloglog"),
              formula = terms(state %in% c("0-0-Ptoid") ~
                        fweek + temp + I(AOP2 + AOP2.gsoh) + I(Col + gsm1) + com + temp:com, 
                        keep.order = T)),
  test.formula = list(
    c("fweek","Residuals"),
    c("temp","temp:com"),
    #c("I(AOP2 + AOP2.gsoh)","com"),
    c("I(Col + gsm1)","com"))
)[[3]] %>%
  select(Source = treatment, 
         `df (Source)` = num_df, 
         `df (Error)` = den_df,
         Deviance = deviance,
         `Mean Deviance` = mean_deviance,
         F = F, P = P, Error = error) %>%
  kable(., caption = "Analysis of deviance for critical transition from initial food web to extinction of all species. Appropriate test for AOP2- allele.", booktabs = T) %>%
  kable_styling(latex_options = c("striped", "hold_position"))

# AOP2+ allele
glm.ftest.v2(
  model = glm(data = filter(full_transit_df, week %in% 7:8),
              family = quasibinomial(link = "cloglog"),
              formula = terms(state %in% c("0-0-Ptoid") ~
                        fweek + temp + I(Col + gsm1) + I(AOP2 + AOP2.gsoh) + com + temp:com, 
                        keep.order = T)),
  test.formula = list(
    c("fweek","Residuals"),
    c("temp","temp:com"),
    c("I(AOP2 + AOP2.gsoh)","com"))
)[[3]] %>%
  select(Source = treatment, 
         `df (Source)` = num_df, 
         `df (Error)` = den_df,
         Deviance = deviance,
         `Mean Deviance` = mean_deviance,
         F = F, P = P, Error = error) %>%
  kable(., caption = "Analysis of deviance for critical transition from initial food web to extinction of all species. Appropriate test for AOP2+ allele.", booktabs = T) %>%
  kable_styling(latex_options = c("striped", "hold_position"))
```

```{r}
# calculate effects sizes for AOP2- and AOP2, Fig. 3 of main text
conf_int(
  glm(data = filter(full_transit_df, week %in% 7:8),
              family = quasibinomial(link = "cloglog"),
              formula = state %in% c("0-0-Ptoid") ~
                fweek + temp + I(AOP2 + AOP2.gsoh) + I(Col + gsm1)),
  vcov = "CR2",
  test = "naive-t",
  cluster = filter(full_transit_df, week %in% 7:8)$com,
  coefs = c("I(AOP2 + AOP2.gsoh)","I(Col + gsm1)")
) %>%
  data.frame() %>%
  rownames_to_column(var = "term") %>%
  group_by(term) %>%
  summarise_at(vars(beta), list(delta_prob = delta_prob))
```

## 0-LYER-Ptoid transition (Table S3)

```{r}
## Organize data for analysis

# LYER-Ptoid cages at least at one time point
LP_cages <- unique(filter(state_df, state == "0-LYER-Ptoid")$cage)
# should be 50 cages, and it is
length(LP_cages)
  
# filter and manage data
LP_transit_df <- state_df %>% 
  filter(cage %in% LP_cages, state != "BRBR-LYER-Ptoid") %>%
  # omit BRBR from consideration
  select(-BRBR_Survival) %>% 
  # omit rows where we already know either LYER or Ptoid went extinct
  na.omit() %>% 
  mutate(# assume these two states are the same, i.e. to get to 0-0-0, had to go through 0-0-Ptoid
         state_adj = ifelse(state %in% c("0-0-Ptoid","0-0-0"), "0-0-Ptoid", state))

# confirm levels
unique(LP_transit_df$state_adj) #fstate)
```

```{r}
# check for weekly variation in critical transitions
LP_transit_df %>%
  mutate(CT_from_FoodChain = ifelse(state_adj %in% c("0-0-Ptoid","0-LYER-0"), 1, 0)) %>%
  group_by(fweek) %>%
  summarise_at("CT_from_FoodChain", mean)
```

We only observe variation between weeks 7 and 16, so we restrict the data to those weeks for the analysis. 

```{r}
LP_transit_df <- filter(LP_transit_df, week %in% c(7:16))
```

```{r}
# adjust rich and temp coefficients, so +1 genotype corresponds to +1 C
LP_transit_df <- LP_transit_df %>%
  mutate(rich = rich-1,
         temp = temp*3)
```


### 0-LYER-Ptoid $\rightarrow$ any critical transition

```{r}
with(LP_transit_df, table(state_adj))
```

```{r}
# AOP2- allele test
glm.ftest.v2(
  model = glm(data = LP_transit_df,
              family = quasibinomial(link = "cloglog"), 
              formula = terms(state_adj %in% c("0-LYER-0","0-0-Ptoid") ~
                        fweek + temp + I(AOP2 + AOP2.gsoh) + I(Col + gsm1) + com + temp:com, 
                        keep.order = T)),
  test.formula = list(
    c("fweek","Residuals"),
    c("temp","temp:com"),
    #c("I(AOP2 + AOP2.gsoh)","com"),
    c("I(Col + gsm1)","com"))
)[[3]] %>%
  select(Source = treatment, 
         `df (Source)` = num_df, 
         `df (Error)` = den_df,
         Deviance = deviance,
         `Mean Deviance` = mean_deviance,
         F = F, P = P, Error = error) %>%
  kable(., caption = "Analysis of deviance for any critical transition from food chain. Appropriate test for AOP2- allele.", booktabs = T) %>%
  kable_styling(latex_options = c("striped", "hold_position"))

# AOP2+ allele test
glm.ftest.v2(
  model = glm(data = LP_transit_df,
              family = quasibinomial(link = "cloglog"), 
              formula = terms(state_adj %in% c("0-LYER-0","0-0-Ptoid") ~
                        fweek + temp + I(Col + gsm1) + I(AOP2 + AOP2.gsoh) + com + temp:com, 
                        keep.order = T)),
  test.formula = list(
    c("fweek","Residuals"),
    c("temp","temp:com"),
    c("I(AOP2 + AOP2.gsoh)","com"))
)[[3]] %>%
  select(Source = treatment, 
         `df (Source)` = num_df, 
         `df (Error)` = den_df,
         Deviance = deviance,
         `Mean Deviance` = mean_deviance,
         F = F, P = P, Error = error) %>%
  kable(., caption = "Analysis of deviance for critical transition from food chain. Appropriate test for AOP2+ allele.", booktabs = T) %>%
  kable_styling(latex_options = c("striped", "hold_position"))
```


### 0-LYER-Ptoid $\rightarrow$ 0-0-Ptoid

```{r}
# check for weekly variation in critical transitions
LP_transit_df %>%
  mutate(CT_FoodChain_to_00Ptoid = ifelse(state_adj == c("0-0-Ptoid"), 1, 0)) %>%
  group_by(week) %>%
  summarise_at("CT_FoodChain_to_00Ptoid", mean)
```

Only observe variation in weeks 7 and 8 and 15 and 16.

```{r}
# AOP2- allele
glm.ftest.v2(
  model = glm(data = filter(LP_transit_df, week %in% c(7,8,15,16)),
              family = quasibinomial(link = "cloglog"), 
              formula = terms(state_adj %in% c("0-0-Ptoid") ~
                        fweek + temp + I(AOP2 + AOP2.gsoh) + I(Col + gsm1) + com + temp:com, 
                        keep.order = T)),
  test.formula = list(
    c("fweek","Residuals"),
    c("temp","temp:com"),
    #c("I(AOP2 + AOP2.gsoh)","com"),
    c("I(Col + gsm1)","com"))
)[[3]] %>%
  select(Source = treatment, 
         `df (Source)` = num_df, 
         `df (Error)` = den_df,
         Deviance = deviance,
         `Mean Deviance` = mean_deviance,
         F = F, P = P, Error = error) %>%
  kable(., caption = "Analysis of deviance for critical transition from food chain to a complete collapse (loss of both aphid and parasitoid). Appropriate test of AOP2- allele.", booktabs = T) %>%
  kable_styling(latex_options = c("striped", "hold_position"))

# AOP2+ allele
glm.ftest.v2(
  model = glm(data = filter(LP_transit_df, week %in% c(7,8,15,16)),
              family = quasibinomial(link = "cloglog"), 
              formula = terms(state_adj %in% c("0-0-Ptoid") ~
                        fweek + temp + I(Col + gsm1) + I(AOP2 + AOP2.gsoh) + com + temp:com, 
                        keep.order = T)),
  test.formula = list(
    c("fweek","Residuals"),
    c("temp","temp:com"),
    c("I(AOP2 + AOP2.gsoh)","com"))
)[[3]] %>%
  select(Source = treatment, 
         `df (Source)` = num_df, 
         `df (Error)` = den_df,
         Deviance = deviance,
         `Mean Deviance` = mean_deviance,
         F = F, P = P, Error = error) %>%
  kable(., caption = "Analysis of deviance for critical transition from food chain to a complete collapse (loss of both aphid and parasitoid). Appropriate test of AOP2+ allele.", booktabs = T) %>%
  kable_styling(latex_options = c("striped", "hold_position"))
```


```{r}
# keystone allele effects sizes in Fig. 3 of main text
conf_int(
  glm(data = filter(LP_transit_df, week %in% c(7,8,15,16)),
              family = quasibinomial(link = "cloglog"), 
              formula = state_adj %in% c("0-0-Ptoid") ~
                fweek + temp + I(AOP2 + AOP2.gsoh) + I(Col + gsm1)),
  vcov = "CR2",
  test = "naive-t",
  cluster = filter(LP_transit_df, week %in% c(7,8,15,16))$com,
  coefs = c("I(AOP2 + AOP2.gsoh)","I(Col + gsm1)")
) %>%
  data.frame() %>%
  rownames_to_column(var = "term") %>%
  group_by(term) %>%
  summarise_at(vars(beta), list(delta_prob = delta_prob))
```


### 0-LYER-Ptoid $\rightarrow$ 0-LYER-0

```{r}
LP_transit_df %>%
  mutate(CT_FoodChain_to_0LYER0 = ifelse(state_adj == c("0-LYER-0"), 1, 0)) %>%
  group_by(week) %>%
  summarise_at("CT_FoodChain_to_0LYER0", mean)
```

We observe variation in all of the same weeks as `LP_transit_df`, so we continue with it for the analysis.

```{r}
# AOP2- allele
glm.ftest.v2(
  model = glm(data = LP_transit_df,
              family = quasibinomial(link = "cloglog"), 
              formula = terms(state_adj %in% c("0-LYER-0") ~
                        fweek + temp + I(AOP2 + AOP2.gsoh) + I(Col + gsm1) + com + temp:com, 
                        keep.order = T)),
  test.formula = list(
    c("fweek","Residuals"),
    c("temp","temp:com"),
    #c("I(AOP2 + AOP2.gsoh)","com"),
    c("I(Col + gsm1)","com"))
)[[3]] %>%
  select(Source = treatment, 
         `df (Source)` = num_df, 
         `df (Error)` = den_df,
         Deviance = deviance,
         `Mean Deviance` = mean_deviance,
         F = F, P = P, Error = error) %>%
  # table of results
  kable(., caption = "Analysis of deviance for critical transition from food chain to an aphid only food web. Appropriate test of AOP2- allele.", booktabs = T) %>%
  kable_styling(latex_options = c("striped", "hold_position"))

# AOP2+ allele
glm.ftest.v2(
  model = glm(data = LP_transit_df,
              family = quasibinomial(link = "cloglog"), 
              formula = terms(state_adj %in% c("0-LYER-0") ~
                        fweek + temp + I(Col + gsm1) + I(AOP2 + AOP2.gsoh) + com + temp:com, 
                        keep.order = T)),
  test.formula = list(
    c("fweek","Residuals"),
    c("temp","temp:com"),
    c("I(AOP2 + AOP2.gsoh)","com"))
)[[3]] %>%
  select(Source = treatment, 
         `df (Source)` = num_df, 
         `df (Error)` = den_df,
         Deviance = deviance,
         `Mean Deviance` = mean_deviance,
         F = F, P = P, Error = error) %>%
  # table of results
  kable(., caption = "Analysis of deviance for critical transition from food chain to an aphid only food web. Appropriate test of AOP2+ allele.", booktabs = T) %>%
  kable_styling(latex_options = c("striped", "hold_position"))
```

```{r}
# keystone allele effect sizes in Fig. 3
conf_int(
  glm(data = LP_transit_df,
              family = quasibinomial(link = "cloglog"), 
              formula = state_adj %in% c("0-LYER-0") ~
                fweek + temp + I(AOP2 + AOP2.gsoh) + I(Col + gsm1)),
  vcov = "CR2",
  test = "naive-t",
  cluster = LP_transit_df$com,
  coefs = c("I(AOP2 + AOP2.gsoh)","I(Col + gsm1)")
) %>%
  data.frame() %>%
  rownames_to_column(var = "term") %>%
  group_by(term) %>%
  summarise_at(vars(beta), list(delta_prob = delta_prob))
```


# Save analysis

Write out an `.RData` file to use for creating the Supplementary Material Results.

```{r}
# save.image(file = "output/critical-transitions-keystone.RData")
```

