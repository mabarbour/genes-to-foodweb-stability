---
title: "Critical transitions"
author: "Matthew A. Barbour"
date: "`r Sys.Date()`"
output: workflowr::wflow_html
editor_options:
  chunk_output_type: console
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, message = FALSE)

# load required libraries
library(tidyverse) # for data management
library(cowplot)
library(msm)
library(clubSandwich)
library(kableExtra)

# set ggplot theme
theme_set(theme_cowplot())
```

# Setup

```{r}
# Load and manage data
df <- read_csv("data/arabidopsis_clean_df.csv") %>%
  # renaming for brevity
  rename(cage = Cage, 
         com = Composition,
         week = Week,
         temp = Temperature,
         rich = Richness) %>%
  mutate(cage = as.character(cage),
         fweek = factor(ifelse(week < 10, paste("0", week, sep=""), week)),
         temp = ifelse(temp=="20 C", 0, 1)) %>%
  arrange(cage, week)

# create data for multi-state survival analysis
state_df <- df %>%
  # counter information is not relevant (because it is the same), so we summarise across it
  group_by(cage, fweek, week, temp, rich, Col, gsm1, AOP2, AOP2.gsoh, com) %>% 
  summarise_at(vars(BRBR_Survival, LYER_Survival, Mummy_Ptoids_Survival), list(mean)) %>% 
  ungroup() %>%
  # create possible food-web states
  mutate(BRBR = ifelse(BRBR_Survival == 1, "BRBR", ifelse(BRBR_Survival == 0, "0", NA)),
         LYER = ifelse(LYER_Survival == 1, "LYER", ifelse(LYER_Survival == 0, "0", NA)),
         Ptoid = ifelse(Mummy_Ptoids_Survival == 1, "Ptoid", ifelse(Mummy_Ptoids_Survival == 0, "0", NA))) %>%
  mutate(state = paste(BRBR, LYER, Ptoid, sep = "-"),
         cage = as.character(cage)) %>%
  # these variables are no longer needed
  select(-BRBR, -LYER, -Ptoid) %>%
  # remove all instances where all species have been labelled extinct for more than 1 week "NA-NA-NA".
  # also, only keep observations after 2 weeks when we added the parasitoid (full community)
  filter(state != "NA-NA-NA", week > 2) %>%
  mutate(week_since = week - 2)

# replace NA with zeros for state variable
state_df$state <- gsub("NA","0", state_df$state)

# everything appears in order
arrange(state_df, cage, week_since) %>% select(cage, week_since, BRBR_Survival, LYER_Survival, Mummy_Ptoids_Survival, state) 
```

```{r}
# source in useful functions for analyses
source('code/glm-ftest.R') # ANOVA GLM
delta_prob = function(x) round(exp(x) - 1,2) # change in probability of transtion from discrete-time survival analysis

```


# Inspect critical transitions

Let's look at the possible state transitions for all cages and time points

```{r}
# state transitions for all cages and time points
msm::statetable.msm(state = state, subject = cage, data = state_df)
```

The most common transition from the full community `BRBR-LYER-Ptoid` is to lose BRBR `0-LYER-Ptoid` and less common to collapse by losing both aphids `0-0-Ptoid`. The `0-0-Ptoid` state never lasts long, since the parasitoid no longer has any resources, and collapses to `0-0-0`.

From the `0-LYER-Ptoid` community, losing the parasitoid `0-LYER-0` is the most common transition, but losing LYER `0-0-Ptoid` is also common. Note that transitions to complete collapse `0-0-0` were more than likely to occur by losing LYER then the parasitoid, rather than losing the parasitoid and then LYER. This is because collapsing from the `0-LYER-0` state is rare (1 / (131 + 1) = `r (1/132)*100`% chance per week).

These transition patterns suggest the following:

* Since the `0-0-Ptoid` state always collapses to `0-0-0`, I'm going to convert the `0-0-Ptoid` state into `0-0-0`. This will reduce the number of state transitions I need to model, but it won't sacrifice modeling the biological process. 
* Since the `0-LYER-0` to `0-0-0` transition is so rare, it does not make sense to model this transition with any covariates.

# Critical transition models

Below, we reproduce the analysis of deviance for discrete-time survival models presented in Tables S1-S2 in the Supplementary Material.

## BRBR-LYER-Ptoid transition (Table S1)

```{r}
# filter data
full_transit_df <- state_df %>% 
  # removes all transitions after the first one, this focuses
  # on transition from the full community
  na.omit() 
```

```{r}
# check for weekly variation in critical transitions. 
full_transit_df %>%
  mutate(CT_from_full = ifelse(state %in% c("0-LYER-Ptoid","0-0-Ptoid"), 1, 0)) %>%
  group_by(fweek) %>%
  summarise_at("CT_from_full", mean)
```

We only observe variation between weeks 4 and 8, so we restrict the data to those weeks for the analysis. It does not make sense to include weeks where there is no variation. If we did, then the factor `fweek` would cause predict all of the variation in the week with no variation.

```{r}
# filter data again
full_transit_df <- filter(full_transit_df, week %in% c(4:8))
```

```{r}
# adjust rich and temp so coefficients = +1 genotype and +1 C, respectively
full_transit_df <- full_transit_df %>%
  mutate(rich  = rich - 1,
         temp = temp * 3)
```

Now we've put the coefficients on a similar and more intuitive scale with respect to each other.

### BRBR-LYER-Ptoid $\rightarrow$ any critical transition

```{r}
full_any_glmf <- glm.ftest.v2(
  model = glm(data = full_transit_df,
              family = quasibinomial(link = "cloglog"), 
              formula = terms(state %in% c("0-LYER-Ptoid","0-0-Ptoid") ~
                        fweek + temp + rich + com + temp:rich + temp:com, 
                        keep.order = T)),
  test.formula = list(
    c("fweek","Residuals"),
    c("temp","temp:com"),
    c("rich","com"),
    c("temp:rich","temp:com"))
)[[3]] %>%
  select(Source = treatment, 
         `df (Source)` = num_df, 
         `df (Error)` = den_df,
         Deviance = deviance,
         `Mean Deviance` = mean_deviance,
         F = F, P = P, Error = error) 

full_any_glmf %>%
  kable(., caption = "Analysis of deviance for critical transition from initial food web.", booktabs = T) %>%
  kable_styling(latex_options = c("striped", "hold_position"))
```

The model didn't converge...Let's try the standard `link = "logit"`.

```{r}
glm.ftest.v2(
  model = glm(data = full_transit_df,
              family = quasibinomial(link = "logit"), 
              formula = terms(state %in% c("0-LYER-Ptoid","0-0-Ptoid") ~
                        fweek + temp + rich + com + temp:rich + temp:com, 
                        keep.order = T)),
  test.formula = list(
    c("fweek","Residuals"),
    c("temp","temp:com"),
    c("rich","com"),
    c("temp:rich","temp:com"))
)[[3]] %>%
  select(Source = treatment, 
         `df (Source)` = num_df, 
         `df (Error)` = den_df,
         Deviance = deviance,
         `Mean Deviance` = mean_deviance,
         F = F, P = P, Error = error)
```

Everything converges now and the results are qualitatively the same as when `link = "cloglog"`. To maintain consistency with the other models, I report the results from `link = "cloglog"`.

```{r include=FALSE}
CT_full_tempCI <- conf_int(
  glm(data = full_transit_df,
              family = quasibinomial(link = "cloglog"),
              formula = state %in% c("0-LYER-Ptoid","0-0-Ptoid") ~
                fweek + temp),
  vcov = "CR2",
  test = "naive-t",
  cluster = with(full_transit_df, paste(temp, com)),
  coefs = "temp"
) %>%
  data.frame() %>%
  rownames_to_column(var = "term")

CT_full_richCI <- conf_int(
  glm(data = full_transit_df,
              family = quasibinomial(link = "cloglog"),
              formula = state %in% c("0-LYER-Ptoid","0-0-Ptoid") ~
                fweek + temp + rich),
  vcov = "CR2",
  test = "naive-t",
  cluster = full_transit_df$com,
  coefs = "rich") %>%
  data.frame() %>%
  rownames_to_column(var = "term") 

bind_rows(CT_full_tempCI, CT_full_richCI) %>%
  ggplot(., aes(x = term, y = exp(beta))) +
  geom_point(size = 5) +
  geom_linerange(aes(ymax = exp(beta + SE), ymin = exp(beta - SE)), size = 1.5) +
  geom_linerange(aes(ymax = exp(CI_U), ymin = exp(CI_L))) +
  geom_hline(yintercept = 1, linetype = "dotted") +
  scale_x_discrete(labels = c("Genetic diversity\n(+1 genotype)","Warming\n (+1Â°C)")) +
  scale_y_continuous("Hazard Ratio") +
  xlab("")
```


### BRBR-LYER-Ptoid $\rightarrow$ 0-LYER-Ptoid

```{r}
# check for weekly variation in critical transitions.
full_transit_df %>%
  mutate(CT_to_0LYERPtoid = ifelse(state %in% "0-LYER-Ptoid", 1, 0)) %>%
  group_by(week) %>%
  summarise_at("CT_to_0LYERPtoid", mean)
```

We keep the `full_transit_df` since we observe variation in all weeks.

```{r}
# fit ANOVA GLM
full_LP_glmf <- glm.ftest.v2(
  model = glm(data = full_transit_df,
              family = quasibinomial(link = "cloglog"), 
              formula = state %in% c("0-LYER-Ptoid") ~
                fweek + temp + rich + com + temp:rich + temp:com),
  test.formula = list(
    c("fweek","Residuals"),
    c("temp","temp:com"),
    c("rich","com"),
    c("temp:rich","temp:com"))
)[[3]] %>%
  select(Source = treatment, 
         `df (Source)` = num_df, 
         `df (Error)` = den_df,
         Deviance = deviance,
         `Mean Deviance` = mean_deviance,
         F = F, P = P, Error = error)

# table of results
full_LP_glmf %>%
  kable(., caption = "Analysis of Deviance for critical transition from initial food web to food chain with dominant aphid and parasitoid.", booktabs = T) %>%
  kable_styling(latex_options = c("striped", "hold_position"))
```

```{r}
# calculate effects sizes for temp, Fig. 2 of main text
conf_int(
  glm(data = full_transit_df,
              family = quasibinomial(link = "cloglog"),
              formula = state %in% c("0-LYER-Ptoid") ~
                fweek + temp),
  vcov = "CR2",
  test = "naive-t",
  cluster = with(full_transit_df, paste(temp, com)),
  coefs = "temp"
) %>%
  data.frame() %>%
  rownames_to_column(var = "term") %>%
  summarise_at(vars(beta), list(delta_prob = delta_prob))

# calculate effects sizes for rich, Fig. 2 of main text
conf_int(
  glm(data = full_transit_df,
              family = quasibinomial(link = "cloglog"),
              formula = state %in% c("0-LYER-Ptoid") ~
                fweek + temp + rich),
  vcov = "CR2",
  test = "naive-t",
  cluster = full_transit_df$com,
  coefs = "rich"
) %>%
  data.frame() %>%
  rownames_to_column(var = "term") %>%
  summarise_at(vars(beta), list(delta_prob = delta_prob))
```


### BRBR-LYER-Ptoid $\rightarrow$ 0-0-Ptoid

```{r}
# check for weekly variation in critical transitions.
full_transit_df %>%
  mutate(CT_to_00Ptoid = ifelse(state %in% "0-0-Ptoid", 1, 0)) %>%
  group_by(week) %>%
  summarise_at("CT_to_00Ptoid", mean)
```

We only see variation in weeks 7 and 8, so we restrict the data to those weeks.

```{r}
# check frequency of critical transitions
with(filter(full_transit_df, week %in% 7:8), table(state %in% c("0-0-Ptoid")))
```

And since there were only 9 total transitions to this state, we don't attempt to fit the interaction term `temp:rich`.

```{r}
glm.ftest.v2(
  model = glm(data = filter(full_transit_df, week %in% 7:8),
              family = quasibinomial(link = "cloglog"),
              formula = state %in% c("0-0-Ptoid") ~
                fweek + temp + rich + com + temp:com),
  test.formula = list(
    c("fweek","Residuals"),
    c("temp","temp:com"),
    c("rich","com"))
)[[3]] %>%
  select(Source = treatment, 
         `df (Source)` = num_df, 
         `df (Error)` = den_df,
         Deviance = deviance,
         `Mean Deviance` = mean_deviance,
         F = F, P = P, Error = error) %>%
  kable(., caption = "Analysis of deviance for critical transition from initial food web to extinction of all species.", booktabs = T) %>%
  kable_styling(latex_options = c("striped", "hold_position"))
```

```{r}
# calculate effects sizes for temp, Fig. 2 of main text
conf_int(
  glm(data = filter(full_transit_df, week %in% 7:8),
              family = quasibinomial(link = "cloglog"),
              formula = state %in% c("0-0-Ptoid") ~
                fweek + temp),
  vcov = "CR2",
  test = "naive-t",
  cluster = with(filter(full_transit_df, week %in% 7:8), paste(temp, com)),
  coefs = "temp"
) %>%
  data.frame() %>%
  rownames_to_column(var = "term") %>%
  summarise_at(vars(beta), list(delta_prob = delta_prob))

# calculate effects sizes for rich, Fig. 2 of main text
conf_int(
  glm(data = filter(full_transit_df, week %in% 7:8),
              family = quasibinomial(link = "cloglog"),
              formula = state %in% c("0-0-Ptoid") ~
                fweek + temp + rich),
  vcov = "CR2",
  test = "naive-t",
  cluster = filter(full_transit_df, week %in% 7:8)$com,
  coefs = "rich"
) %>%
  data.frame() %>%
  rownames_to_column(var = "term") %>%
  summarise_at(vars(beta), list(delta_prob = delta_prob))
```

## 0-LYER-Ptoid transition (Table S2)

```{r}
## Organize data for analysis

# LYER-Ptoid cages at least at one time point
LP_cages <- unique(filter(state_df, state == "0-LYER-Ptoid")$cage)
# should be 50 cages, and it is
length(LP_cages)
  
# filter and manage data
LP_transit_df <- state_df %>% 
  filter(cage %in% LP_cages, state != "BRBR-LYER-Ptoid") %>%
  # omit BRBR from consideration
  select(-BRBR_Survival) %>% 
  # omit rows where we already know either LYER or Ptoid went extinct
  na.omit() %>% 
  mutate(# assume these two states are the same, i.e. to get to 0-0-0, had to go through 0-0-Ptoid
         state_adj = ifelse(state %in% c("0-0-Ptoid","0-0-0"), "0-0-Ptoid", state))

# confirm levels
unique(LP_transit_df$state_adj) #fstate)
```

```{r}
# check for weekly variation in critical transitions
LP_transit_df %>%
  mutate(CT_from_FoodChain = ifelse(state_adj %in% c("0-0-Ptoid","0-LYER-0"), 1, 0)) %>%
  group_by(fweek) %>%
  summarise_at("CT_from_FoodChain", mean)
```

We only observe variation between weeks 7 and 16, so we restrict the data to those weeks for the analysis. 

```{r}
LP_transit_df <- filter(LP_transit_df, week %in% c(7:16))
```

```{r}
# adjust rich and temp coefficients, so +1 genotype corresponds to +1 C
LP_transit_df <- LP_transit_df %>%
  mutate(rich = rich-1,
         temp = temp*3)
```


### 0-LYER-Ptoid $\rightarrow$ any critical transition (Fig. 3 of main text)

```{r}
with(LP_transit_df, table(state_adj))
```

```{r}
# fit ANOVA glm
LP_any_glmf <- glm.ftest.v2(
  model = glm(data = LP_transit_df,
              family = quasibinomial(link = "cloglog"), 
              formula = state_adj %in% c("0-LYER-0","0-0-Ptoid") ~
                fweek + temp + rich + com + temp:rich + temp:com),
  test.formula = list(
    c("fweek","Residuals"),
    c("temp","temp:com"),
    c("rich","com"),
    c("temp:rich","temp:com"))
)[[3]] %>%
  select(Source = treatment, 
         `df (Source)` = num_df, 
         `df (Error)` = den_df,
         Deviance = deviance,
         `Mean Deviance` = mean_deviance,
         F = F, P = P, Error = error) 

# table of results
LP_any_glmf %>%
  kable(., caption = "Analysis of deviance for critical transition from food chain.", booktabs = T) %>%
  kable_styling(latex_options = c("striped", "hold_position"))
```

```{r}
# rich effect sizes reported in Fig. 3A of main text
rich_HR_CI <- conf_int(
  glm(data = LP_transit_df, 
      family = binomial(link = "cloglog"),
      formula = state_adj %in% c("0-LYER-0","0-0-Ptoid") ~ fweek + temp + rich),
  vcov = "CR2", 
  test = "naive-t", 
  coefs = "rich", 
  cluster = LP_transit_df$com) %>%
  data.frame() %>%
  rownames_to_column(var = "term")

# genotype-specific effects sizes reported in Fig. 3B of main text
geno_HR_CI <- conf_int(
  glm(data = LP_transit_df, 
      family = binomial(link = "cloglog"),
      formula = state_adj %in% c("0-LYER-0","0-0-Ptoid") ~ fweek + temp + Col + gsm1 + AOP2 + AOP2.gsoh), # fstate
  vcov = "CR2", 
  test = "naive-t", 
  coefs = c("Col","gsm1","AOP2","AOP2.gsoh"), 
  cluster = LP_transit_df$com) %>%
  data.frame() %>%
  rownames_to_column(var = "term")

# reproduce Fig. 3B in main text
geno_HR_CI %>%
  mutate(term = factor(term, 
                       levels = c("Col","gsm1","AOP2","AOP2.gsoh"))) %>%
  ggplot(aes(x = term, y = (exp(beta)-1)*100, color = term)) +
  geom_point(size = 3) +
  geom_hline(yintercept = 0, linetype = "dotted") +
  geom_linerange(aes(ymax = (exp(CI_U)-1)*100, ymin = (exp(CI_L)-1)*100)) +
  geom_linerange(aes(ymin = (exp(beta - SE)-1)*100, ymax = (exp(beta + SE)-1)*100), size = 1.25) +
  scale_y_continuous(name = expression("Risk of critical transition "(Delta~"%"))) +
  scale_x_discrete(labels = c("Col-0","gsm1","AOP2","AOP2/gsoh")) +
  scale_color_manual(values = c("darkgreen","steelblue","darkorange","firebrick1"), guide = F) +
  xlab("") +
  theme_cowplot(font_size = 18, line_size = 1)
ggsave("figures/rich-geno-critical-transition-v4.pdf", width = 8, height = 8, units = "in")
```

```{r include=FALSE}
# temp effect sizes, not discussed in main text because they didn't have a clear effect
temp_HR_CI <- conf_int(
  glm(data = LP_transit_df, 
      family = binomial(link = "cloglog"),
      formula = state_adj %in% c("0-LYER-0","0-0-Ptoid") ~ fweek + temp),
  vcov = "CR2", 
  test = "naive-t", 
  coefs = "temp", 
  cluster = with(LP_transit_df, paste(temp, com))) %>%
  data.frame() %>%
  rownames_to_column(var = "term")

bind_rows(temp_HR_CI, rich_HR_CI) %>%
  mutate(term = factor(term, 
                       levels = c("temp","rich"))) %>%
  ggplot(aes(x = term, y = exp(beta), color = term)) +
  geom_point(size = 3) +
  geom_hline(yintercept = 1, linetype = "dotted") +
  geom_linerange(aes(ymax = exp(CI_U), ymin = exp(CI_L))) +
  geom_linerange(aes(ymin = exp(beta - SE), ymax = exp(beta + SE)), size = 1.25) +
  scale_y_continuous(name = "Hazard ratio", breaks = c(0.25, 0.5, 0.75, 1, 1.25, 1.5, 1.75)) +
  scale_x_discrete(labels = c("Warming\n (+1Â°C)","Genetic diversity\n(+1 genotype)")) +
  scale_color_manual(values = c("black","black"), guide = F) +
  xlab("") +
  theme_cowplot(font_size = 18, line_size = 1)

bind_rows(rich_HR_CI, geno_HR_CI) %>%
  mutate(term = factor(term, 
                       levels = c("rich","Col","gsm1","AOP2","AOP2.gsoh"))) %>%
  ggplot(aes(x = term, y = exp(beta), color = term)) +
  geom_point(size = 3) +
  geom_hline(yintercept = 1, linetype = "dotted") +
  geom_linerange(aes(ymax = exp(CI_U), ymin = exp(CI_L))) +
  geom_linerange(aes(ymin = exp(beta - SE), ymax = exp(beta + SE)), size = 1.25) +
  scale_y_continuous(name = "Hazard ratio", breaks = c(0.25, 0.5, 0.75, 1, 1.25, 1.5, 1.75)) +
  scale_x_discrete(labels = c("Diversity\n(+1 genotype)","Col-0","gsm1","AOP2","AOP2/gsoh")) +
  scale_color_manual(values = c("black","darkgreen","steelblue","darkorange","firebrick1"), guide = F) +
  xlab("") +
  theme_cowplot(font_size = 18, line_size = 1)
ggsave("figures/rich-geno-critical-transition.pdf", width = 8, height = 6, units = "in")
```


### 0-LYER-Ptoid $\rightarrow$ 0-0-Ptoid

```{r}
# check for weekly variation in critical transitions
LP_transit_df %>%
  mutate(CT_FoodChain_to_00Ptoid = ifelse(state_adj == c("0-0-Ptoid"), 1, 0)) %>%
  group_by(week) %>%
  summarise_at("CT_FoodChain_to_00Ptoid", mean)
```

Only observe variation in weeks 7 and 8 and 15 and 16.

```{r}
# fit ANOVA GLM
LP_to_00Ptoid_glmf <- glm.ftest.v2(
  model = glm(data = filter(LP_transit_df, week %in% c(7,8,15,16)),
              family = quasibinomial(link = "cloglog"), 
              formula = state_adj %in% c("0-0-Ptoid") ~
                fweek + temp + rich + com + temp:rich + temp:com),
  test.formula = list(
    c("fweek","Residuals"),
    c("temp","temp:com"),
    c("rich","com"),
    c("temp:rich","temp:com"))
)[[3]] %>%
  select(Source = treatment, 
         `df (Source)` = num_df, 
         `df (Error)` = den_df,
         Deviance = deviance,
         `Mean Deviance` = mean_deviance,
         F = F, P = P, Error = error) 

# table of results
LP_to_00Ptoid_glmf %>%
  kable(., caption = "Analysis of deviance for critical transition from food chain to a complete collapse (loss of both aphid and parasitoid).", booktabs = T) %>%
  kable_styling(latex_options = c("striped", "hold_position"))
```

```{r}
# temp effect sizes reported in Fig. 2 of main text
conf_int(
  glm(data = filter(LP_transit_df, week %in% c(7,8,15,16)),
              family = quasibinomial(link = "cloglog"), 
              formula = state_adj %in% c("0-0-Ptoid") ~
                fweek + temp),
  vcov = "CR2",
  test = "naive-t",
  cluster = with(filter(LP_transit_df, week %in% c(7,8,15,16)), paste(temp,com)),
  coefs = "temp"
) %>%
  data.frame() %>%
  rownames_to_column(var = "term") %>%
  summarise_at(vars(beta), list(delta_prob = delta_prob))

# rich effect sizes reported in Fig. 2 of main text
conf_int(
  glm(data = filter(LP_transit_df, week %in% c(7,8,15,16)),
              family = quasibinomial(link = "cloglog"), 
              formula = state_adj %in% c("0-0-Ptoid") ~
                fweek + temp + rich),
  vcov = "CR2",
  test = "naive-t",
  cluster = filter(LP_transit_df, week %in% c(7,8,15,16))$com,
  coefs = "rich"
) %>%
  data.frame() %>%
  rownames_to_column(var = "term") %>%
  summarise_at(vars(beta), list(delta_prob = delta_prob))
```

```{r include=FALSE}
conf_int(
  glm(data = filter(LP_transit_df, week %in% c(7,8,15,16)),
              family = quasibinomial(link = "cloglog"), 
              formula = state_adj %in% c("0-0-Ptoid") ~
                fweek + temp + Col + gsm1 + AOP2 + AOP2.gsoh),
  vcov = "CR2",
  test = "naive-t",
  cluster = filter(LP_transit_df, week %in% c(7,8,15,16))$com,
  coefs = c("Col","gsm1","AOP2","AOP2.gsoh")
)
```

### 0-LYER-Ptoid $\rightarrow$ 0-LYER-0

```{r}
LP_transit_df %>%
  mutate(CT_FoodChain_to_0LYER0 = ifelse(state_adj == c("0-LYER-0"), 1, 0)) %>%
  group_by(week) %>%
  summarise_at("CT_FoodChain_to_0LYER0", mean)
```

We observe variation in all of the same weeks as `LP_transit_df`, so we continue with it for the analysis.

```{r}
# fit ANOVA glm
glm.ftest.v2(
  model = glm(data = LP_transit_df,
              family = quasibinomial(link = "cloglog"), 
              formula = state_adj %in% c("0-LYER-0") ~
                fweek + temp + rich + com + temp:rich + temp:com),
  test.formula = list(
    c("fweek","Residuals"),
    c("temp","temp:com"),
    c("rich","com"),
    c("temp:rich","temp:com"))
)[[3]] %>%
  select(Source = treatment, 
         `df (Source)` = num_df, 
         `df (Error)` = den_df,
         Deviance = deviance,
         `Mean Deviance` = mean_deviance,
         F = F, P = P, Error = error) %>%
  # table of results
  kable(., caption = "Analysis of deviance for critical transition from food chain to an aphid only food web.", booktabs = T) %>%
  kable_styling(latex_options = c("striped", "hold_position"))
```

```{r}
# temp effect sizes reported in Fig. 2 of main text
conf_int(
  glm(data = LP_transit_df,
              family = quasibinomial(link = "cloglog"), 
              formula = state_adj %in% c("0-LYER-0") ~
                fweek + temp),
  vcov = "CR2",
  test = "naive-t",
  cluster = with(LP_transit_df, paste(temp,com)),
  coefs = "temp"
) %>%
  data.frame() %>%
  rownames_to_column(var = "term") %>%
  summarise_at(vars(beta), list(delta_prob = delta_prob))

# rich effect sizes reported in Fig. 2 of main text
conf_int(
  glm(data = LP_transit_df,
              family = quasibinomial(link = "cloglog"), 
              formula = state_adj %in% c("0-LYER-0") ~
                fweek + temp + rich),
  vcov = "CR2",
  test = "naive-t",
  cluster = LP_transit_df$com,
  coefs = "rich"
) %>%
  data.frame() %>%
  rownames_to_column(var = "term") %>%
  summarise_at(vars(beta), list(delta_prob = delta_prob))
```

```{r include=FALSE}
conf_int(
  glm(data = LP_transit_df,
              family = quasibinomial(link = "cloglog"), 
              formula = state_adj %in% c("0-LYER-0") ~
                fweek + temp + Col + gsm1 + AOP2 + AOP2.gsoh),
  vcov = "CR2",
  test = "naive-t",
  cluster = LP_transit_df$com,
  coefs = c("Col","gsm1","AOP2","AOP2.gsoh")
)
```


# Multinomial models

Focus on states in last week for multinomial model

```{r}
state_df_17 <- df %>%
  # counter information is not relevant (because it is the same), so we summarise across it
  group_by(cage, fweek, week, temp, rich, Col, gsm1, AOP2, AOP2.gsoh, com) %>% 
  summarise_at(vars(BRBR_Survival, LYER_Survival, Mummy_Ptoids_Survival), list(mean)) %>%
  ungroup() %>%
  # we need the dataset to go through week 17, rather than removing cages as they transition
  # to a collapsed community as in `state_df`
  mutate(BRBR = ifelse(is.na(BRBR_Survival) == T, 0, BRBR_Survival),
         LYER = ifelse(is.na(LYER_Survival) == T, 0, LYER_Survival),
         Ptoid = ifelse(is.na(Mummy_Ptoids_Survival) == T, 0, Mummy_Ptoids_Survival),
         state = paste(BRBR, LYER, Ptoid, sep = "-"),
         value = 1) %>%
  filter(week == 17) 
```

Now let's inspect the possible states

```{r}
with(state_df_17, table(state))
```

Note there are only several `0-1-1` states. It seems unwise to try and fit the statistical interaction `temp:rich` to test whether there is a non-additive effect of `rich` and `temp` on the probability of this state. Moreover, we have no evidence for non-additive effects between `rich` and `temp` from our critical transition analysis. Therefore, we fit a simpler model with the interaction term `temp:rich`.

```{r}
## Organize data 

# we use the "Poisson trick" so we can analyze the multinomial model as a Poisson GLM.
# note that they are equivalent, and this allowed us to conduct our ANOVA GLM and test
# terms agains the appropriate error term.
pois.trans_state_df_17 <- state_df_17 %>%
  mutate(value = 1) %>%
  select(cage, temp, rich, com, state, value) %>%
  pivot_wider(id_cols = c("cage","temp","rich","com"), 
              names_from = state, 
              values_from = value,
              values_fill = list(value = 0)) %>%
  gather(state, value, -(cage:com)) %>%
  ungroup() %>%
  mutate(# place coefficients on comparable scale
         rich = rich - 1, # now monoculture corresponds to the intercept term in the model
         temp = temp * 3,
         # set different baselines for testing
         state000_ = factor(state, levels = c("0-0-0","0-1-0","0-1-1")),
         state011_ = factor(state, levels = c("0-1-1","0-1-0","0-0-0")))
```

```{r include=FALSE}
glm.ftest.v2(
  model = glm(data = pois.trans_state_df_17,
              family = quasipoisson(link = "log"), 
              formula = terms(value ~ state011_ + rich + temp + com + temp:com + cage + # baseline parameters
                state011_:temp + state011_:rich + state011_:com + state011_:temp:com,
                keep.order = T)), 
  test.formula = list(
    c("state011_:temp","state011_:temp:com"),
    c("state011_:rich","state011_:com"),
    c("state011_:com","state011_:temp:com"),
    c("state011_:temp:com","Residuals"))
)
```


```{r include=FALSE}
conf_int(
  glm(data = pois.trans_state_df_17,
              family = quasipoisson(link = "log"), 
              formula = value ~ state011_ + rich + temp + com + temp:com + cage + # baseline parameters
                state011_:temp + state011_:rich),
  vcov = "CR2",
  test = "naive-t",
  cluster = with(pois.trans_state_df_17, paste(state011_, com)),
  coefs = c("state011_0-1-0:rich","state011_0-0-0:rich")
)

conf_int(
  glm(data = pois.trans_state_df_17,
              family = quasipoisson(link = "log"), 
              formula = value ~ state011_ + rich + temp + com + temp:com + cage + # baseline parameters
                state011_:temp),
  vcov = "CR2",
  test = "naive-t",
  cluster = with(pois.trans_state_df_17, paste(state011_, temp, com)),
  coefs = c("state011_0-1-0:temp","state011_0-0-0:temp")
)
```

```{r}
# fit ANOVA GLM
multinom_glmf <- glm.ftest.v2(
  model = glm(data = pois.trans_state_df_17,
              family = quasipoisson(link = "log"), 
              formula = terms(value ~ state000_ + rich + temp + com + temp:rich + temp:com + cage + # baseline parameters
                state000_:temp + state000_:rich + state000_:com + state000_:temp:com,
                keep.order = T)), 
  test.formula = list(
    c("state000_:temp","state000_:temp:com"),
    c("state000_:rich","state000_:com"))
)[[3]] %>%
  mutate(treatment = c("temp","rich"), error = c("temp:com","com")) %>%
  select(Source = treatment, 
         `df (Source)` = num_df, 
         `df (Error)` = den_df,
         Deviance = deviance,
         `Mean Deviance` = mean_deviance,
         F = F, P = P, Error = error) 

# table of results, which we report directly in main text
multinom_glmf %>%
  kable(., caption = "Analysis of deviance for multinomial model of food-web structures at the end of the experiment.", booktabs = T) %>%
  kable_styling(latex_options = c("striped", "hold_position"))
```


```{r}
# calculate temp effect size on each state relative to complete collapse
multi_temp_CI <- conf_int(
  glm(data = pois.trans_state_df_17,
              family = quasipoisson(link = "log"), 
              formula = value ~ state000_ + rich + temp + com + temp:com + #cage + # baseline parameters
                state000_:temp),
  vcov = "CR2",
  test = "naive-t",
  cluster = with(pois.trans_state_df_17, paste(state000_, temp, com)),
  coefs = c("state000_0-1-0:temp","state000_0-1-1:temp")
) %>%
  data.frame() %>%
  rownames_to_column(var = "term")

# calculate rich effect size on each state relative to complete collapse
multi_rich_CI <- conf_int(
  glm(data = pois.trans_state_df_17,
              family = quasipoisson(link = "log"), 
              formula = value ~ state000_ + rich + temp + com + temp:com + #cage + # baseline parameters
                state000_:temp + state000_:rich),
  vcov = "CR2",
  test = "naive-t",
  cluster = with(pois.trans_state_df_17, paste(state000_, com)),
  coefs = c("state000_0-1-0:rich","state000_0-1-1:rich")
) %>%
  data.frame() %>%
  rownames_to_column(var = "term")

# reproduce Fig. S4 in Supplementary Material
bind_rows(multi_rich_CI, multi_temp_CI) %>%
  mutate(term = factor(term, 
                       levels = c("state000_0-1-0:temp","state000_0-1-1:temp",
                                  "state000_0-1-0:rich","state000_0-1-1:rich"))) %>%
  separate(term, into = c("state_comparison","treatment"), sep = ":") %>%
  mutate(treatment = factor(treatment, 
                            levels = c("rich","temp"))) %>%
  mutate(state_comparison = factor(state_comparison, 
                                   levels = c("state000_0-1-1","state000_0-1-0"),
                                   labels = c("Food chain vs. complete collapse",
                                              "Aphid only vs. complete collapse"))) %>%
  ggplot(aes(x = treatment, y = exp(beta))) +
  geom_point(size = 3) +
  geom_hline(yintercept = 1, linetype = "dotted") +
  geom_linerange(aes(ymax = exp(CI_U), ymin = exp(CI_L))) +
  geom_linerange(aes(ymin = exp(beta - SE), ymax = exp(beta + SE)), size = 1.25) +
  scale_y_continuous(name = "Odds ratio") +
  scale_x_discrete(labels = c("Genetic diversity\n(+1 genotype)","Warming\n (+1Â°C)")) +
  xlab("") +
  facet_wrap(~state_comparison, ncol = 1) +
  theme_cowplot(font_size = 18, line_size = 1)
```

# Save analysis

Write out an `.RData` file to use for creating the Supplementary Material Results.

```{r}
save.image(file = "output/critical-transitions.RData")
```

